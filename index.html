<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tamagotchi Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; background: #121212; color: white; margin: 0; }
        .screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; padding: 20px; box-sizing: border-box; }
        .hidden { display: none; }
        #loader h1 { color: #74b9ff; }
        #error h1 { color: #ff7675; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 20px; margin-top: 20px; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .fill { height: 100%; transition: width 0.5s; }
        .pet { font-size: 100px; margin: 20px 0; }
        .actions-bar { display: flex; gap: 10px; margin-top: 20px; }
        .action-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 15px; border-radius: 12px; font-size: 20px; }
    </style>
</head>
<body>

    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="loader" class="screen">
        <h1>–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É...</h1>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏</p>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ (—Å–∫—Ä—ã—Ç) -->
    <div id="error" class="screen hidden">
        <h1 id="error-title"></h1>
        <p id="error-text"></p>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã (—Å–∫—Ä—ã—Ç) -->
    <div id="game" class="screen hidden">
        <div>LVL <span id="lvl">1</span> | ü™ô <span id="coins">100</span></div>
        <div id="pet" class="pet">üê£</div>
        <div class="stats-grid">
            <div>‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ <div class="progress-bar"><div id="bar-hp" class="fill" style="background:#ff7675;"></div></div></div>
            <div>üçî –ì–æ–ª–æ–¥ <div class="progress-bar"><div id="bar-food" class="fill" style="background:#ffeaa7;"></div></div></div>
            <div>üòÑ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ <div class="progress-bar"><div id="bar-mood" class="fill" style="background:#74b9ff;"></div></div></div>
            <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è <div class="progress-bar"><div id="bar-energy" class="fill" style="background:#55efc4;"></div></div></div>
        </div>
        <div class="actions-bar">
            <button class="action-btn" onclick="doAction('feed')">üçî</button>
            <button class="action-btn" onclick="doAction('walk')">üå≥</button>
        </div>
    </div>

    <script>
            // 1. –°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—ä–µ–∫—Ç TG
        const tg = window.Telegram ? window.Telegram.WebApp : null;
        
        // 2. –ü—Ä–æ–±—É–µ–º –¥–æ—Å—Ç–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π ID
        let myId = 12345; // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            myId = tg.initDataUnsafe.user.id;
            console.log("ID –∏–≥—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–∑ Telegram:", myId);
        } else {
            console.log("–î–∞–Ω–Ω—ã–µ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ID:", myId);
        }
        
        // –°–æ–æ–±—â–∞–µ–º –¢–µ–ª–µ–≥—Ä–∞–º—É, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        if (tg && tg.ready) tg.ready();
        if (tg && tg.expand) tg.expand();
        
        // üõë –í–ê–ñ–ù–û: –¢–≤–æ—è —Å—Å—ã–ª–∫–∞ Ngrok (–ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–Ω–∞ —Ç–∞–∫–∞—è –∂–µ!)
        
        const API_URL = "https://salubriously-ophthalmic-eveline.ngrok-free.dev";
        const myId = tg.initDataUnsafe.user.id;

        const loaderScreen = document.getElementById('loader');
        const errorScreen = document.getElementById('error');
        const gameScreen = document.getElementById('game');

        function showError(title, message) {
            loaderScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            errorScreen.classList.remove('hidden');
            document.getElementById('error-title').innerText = title;
            document.getElementById('error-text').innerText = message;
        }

        function showGame(data) {
            updateUI(data); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
            loaderScreen.classList.add('hidden');
            errorScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }

        function updateUI(data) {
            document.getElementById('lvl').innerText = data.lvl;
            document.getElementById('coins').innerText = data.coins;
            document.getElementById('bar-hp').style.width = data.hp + '%';
            document.getElementById('bar-food').style.width = data.food + '%';
            document.getElementById('bar-mood').style.width = data.mood + '%';
            document.getElementById('bar-energy').style.width = data.energy + '%';
        }

        async function loadData() {
            try {
                const response = await fetch(`${API_URL}/api/get_user/${myId}`, {
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ /start –≤ –±–æ—Ç–µ!");
                
                showGame(data);

            } catch (e) {
                console.error(e);
                showError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è!", `–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ Python –∏ Ngrok –∑–∞–ø—É—â–µ–Ω—ã. –î–µ—Ç–∞–ª–∏: ${e.message}`);
            }
        }
        
        async function doAction(actionName) {
            try {
                const response = await fetch(`${API_URL}/api/action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                    body: JSON.stringify({ user_id: myId, action: actionName })
                });
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è');
                const result = await response.json();
                alert(result.message); // –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            } catch(e) {
                alert(`–û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—ë
        loadData();
    </script>
</body>
</html>


